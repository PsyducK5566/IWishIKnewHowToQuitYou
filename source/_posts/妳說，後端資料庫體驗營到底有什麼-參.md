---
title: 妳說，後端資料庫體驗營到底有什麼? 參
date: 2024-11-27 21:15:43
tags: Practice
description: 才要出發，每日任務不就是這回事嗎﹖
---
### 教練身份講解
在一個網頁平台上，會有多種角色，而在我們的任務二中的角色(role)會有：

一般客戶：USER
教練：COACH
在我們的[線稿圖](https://miro.com/app/board/uXjVLbiDml0=/)中，也有繪製如果他是教練角色時，他可以填寫自己的相關教練資料，其中欄位包含：

大頭照
教練姓名
教練資歷
教練簡介
專長(可複選)
![picture](https://firebasestorage.googleapis.com/v0/b/pictureforu-3b8e9.appspot.com/o/SQL%20%3A%2020241127%20Practice%2Fdownload.png?alt=media&token=57824e50-be4f-4faa-8a92-5b194aa5fe7a)

```sql
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE TABLE "USER" (
  "id" uuid PRIMARY KEY NOT NULL DEFAULT (gen_random_uuid()),
  "name" varchar(50) NOT NULL,
  "email" varchar(320) UNIQUE NOT NULL,
  "role" varchar(20) NOT NULL,
  "created_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP),
  "updated_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP)
);

CREATE TABLE "COACH" (
  "id" uuid PRIMARY KEY NOT NULL DEFAULT uuid_generate_v4(),
  "user_id" uuid NOT NULL REFERENCES "USER"(id),
  "experience_years" integer,
  "description" text,
  "profile_image_url" varchar(2048),
  "created_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP),
  "updated_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP),
  UNIQUE("user_id")
);

CREATE TABLE "CREDIT_PACKAGE" (
  "id" serial PRIMARY KEY,
  "name" varchar(50) NOT NULL,
  "credit_amount" integer NOT NULL,
  "price" numeric(10,2) NOT NULL,
  "created_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP)
);

CREATE TABLE "CREDIT_PURCHASE" (
  "id" uuid PRIMARY KEY NOT NULL DEFAULT (gen_random_uuid()),
  "user_id" uuid NOT NULL REFERENCES "USER"(id),
  "credit_package_id" integer NOT NULL REFERENCES "CREDIT_PACKAGE"(id),
  "purchased_credits" integer NOT NULL,
  "price_paid" numeric(10,2) NOT NULL,
  "created_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP),
  "purchase_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP)
);

INSERT INTO "USER" ("name", "email", "role")
VALUES
  ('李燕容', 'lee2000@hexschooltest.io', 'USER'),
  ('王小明', 'wXlTq@hexschooltest.io', 'USER'),
  ('肌肉棒子', 'muscle@hexschooltest.io', 'USER'),
  ('好野人', 'richman@hexschooltest.io', 'USER'),
  ('Q太郎', 'starplatinum@hexschooltest.io', 'USER'),
  ('透明人', 'opacity0@hexschooltest.io', 'USER');

```
### 分析資料表結構與關聯
根據提供的資料表結構，以下是每個資料表的功能與關聯性分析：

**1. USER 資料表**
+ 功能：儲存使用者的基本資訊。
+ 欄位說明：
    + id：主鍵，唯一標識每個使用者。
    + name：使用者名稱。
    + email：使用者電子郵件，必須唯一。
    + role：使用者角色，可選值有 "USER" 和 "COACH"。
    + created_at / updated_at：記錄資料建立與更新的時間。

**2. COACH 資料表**
+ 功能：儲存教練的詳細資訊。
+ 欄位說明：
    + id：主鍵，唯一標識每位教練。
    + user_id：外鍵，參考 USER 表的 id，表示該教練是某位使用者。
    + experience_years：教練的經驗年數。
    + description：教練的個人描述。
    + profile_image_url：教練的個人頭像連結。
    + created_at / updated_at：記錄資料建立與更新的時間。
+ 關聯性：
    + 每位教練對應到 USER 表中的一位使用者（1 對 1 關係）。
    + user_id 欄位設置了唯一性約束（UNIQUE），確保一位使用者只能成為一位教練。

**3. CREDIT_PACKAGE 資料表**
+ 功能：儲存可購買的點數包資訊。
+ 欄位說明：
    + id：主鍵，自動遞增。
    + name：點數包名稱（例如："入門點數包"）。
    + credit_amount：點數包內包含的點數數量。
    + price：點數包的售價。
    + created_at：記錄資料建立時間。

**4. CREDIT_PURCHASE 資料表**
+ 功能：記錄使用者購買點數包的交易資訊。
+ 欄位說明：
    + id：主鍵，唯一標識每筆交易。
    + user_id：外鍵，參考 USER 表的 id，表示購買者。
    + credit_package_id：外鍵，參考 CREDIT_PACKAGE 表的 id，表示購買的點數包。
    + purchased_credits：實際購買的點數數量。
    + price_paid：購買時支付的金額。
    + created_at / purchase_at：記錄交易的建立與購買時間。
+ 關聯性：
    + 每筆交易對應到一位使用者（多對一關係）。
    + 每筆交易對應到一個點數包（多對一關係）。

### 資料表間的關係
1.USER 與 COACH：
+ 一對一（One-to-One）：一位使用者可以是教練（COACH 表），但不是所有使用者都是教練。
+ COACH 表的 user_id 是 USER 表的外鍵，且設置了唯一性約束。

2.USER 與 CREDIT_PURCHASE：
+ 一對多（One-to-Many）：一位使用者可以有多筆點數包購買記錄。

3.CREDIT_PACKAGE 與 CREDIT_PURCHASE：
+ 一對多（One-to-Many）：一個點數包可以被多位使用者購買。

### 教練資料 ，資料表為 COACH
**新增：**在 COACH 資料表新增三筆資料，資料需求如下：
將用戶 李燕容 新增為教練，並且年資設定為2年（提示：使用 李燕容 的email ，取得 李燕容 的 id ）
將用戶肌肉棒子新增為教練，並且年資設定為2年（提示：使用 肌肉棒子 的email ，取得 肌肉棒子 的 id ）
將用戶Q太郎新增為教練，並且年資設定為2年（提示：使用 Q太郎 的email ，取得 Q太郎 的 id ）

根據需求，需透過 USER 資料表中的 email 欄位，取得以下 3 位使用者的 id：

<font color=#0000FF> ln [1]: </font>

```sql
SELECT id, name, email FROM "USER"
WHERE email IN ('lee2000@hexschooltest.io', 'muscle@hexschooltest.io', 'starplatinum@hexschooltest.io');
```

<font color=#FF0000> Out [1]:  </font>

![1](https://firebasestorage.googleapis.com/v0/b/pictureforu-3b8e9.appspot.com/o/SQL%20%3A%2020241127%20Practice%2F1(4).png?alt=media&token=fce1450e-23c8-449e-8f64-f50487a52adb)

使用查詢出的 id，將這 3 位使用者新增為教練，並設定年資為 2 年。

<font color=#0000FF> ln [2]: </font>

```sql
INSERT INTO "COACH" ("user_id", "experience_years", "description", "profile_image_url")
VALUES 
  ('6f1f764a-26ba-451c-8c3b-3ebd508584f5', 2, '熱愛健身與教學的教練', NULL),
  ('b8843ac6-9480-4de3-a1d5-7105e66a0acf', 2, '專注於力量訓練的教練', NULL),
  ('6e5c289a-70ed-49fb-b2bd-313f3558d5b3', 2, '24小時耐力訓練的專家', NULL);
```
<font color=#FF0000> Out [2]:  </font>

![2](https://firebasestorage.googleapis.com/v0/b/pictureforu-3b8e9.appspot.com/o/SQL%20%3A%2020241127%20Practice%2F2.png?alt=media&token=106d15b5-2b2a-4ade-b6cd-cca95bf7e6fc)

執行以下查詢，確認是否成功新增這三位教練：

<font color=#0000FF> ln [3]: </font>

```sql
SELECT c.id AS coach_id, u.name AS user_name, c.experience_years, c.description
FROM "COACH" c
JOIN "USER" u ON c.user_id = u.id;
```

![3](https://firebasestorage.googleapis.com/v0/b/pictureforu-3b8e9.appspot.com/o/SQL%20%3A%2020241127%20Practice%2F1(4).png?alt=media&token=fce1450e-23c8-449e-8f64-f50487a52adb)

## 何謂一對多、一對一
### 解釋一對多關係
口訣：「多的要設定外來鍵」
流程：從欄位角度去規劃
1.以「使用者」角度：一個「使用者」會有多筆購買紀錄
2.以「購買紀錄」角度：一筆「購買紀錄」只會屬於 一個 使用者
➡️ 所以在「購買紀錄」表格（多的那方）設定外來鍵

```sql
-- 一對多（使用者 -> 購買紀錄） 
CREATE TABLE "CREDIT_PURCHASE" (     
    "user_id" uuid NOT NULL REFERENCES "USER"(id),  -- 多的那方加外來鍵    
); 
```
### 解釋一對一關係
口訣：「外來鍵加唯一值」
流程：從欄位角度去規劃
1.以「使用者」角度：一個「使用者」最多只能是 一個 教練
2.以「教練」角度：一個「教練」只能對應到 一個 使用者
在雙方資料表都只能對應一個資訊時，則會是一對一的資料關係
➡️ 所以在「教練」表格設定外來鍵，並加上 UNIQUE 限制

```sql
-- 一對一（使用者 <-> 教練） 
CREATE TABLE "COACH" (     
    "user_id" uuid NOT NULL REFERENCES "USER"(id) 
    -- ...
    UNIQUE("user_id")  -- 外來鍵加唯一值 
);`
```

**UNIQUE 意思：**表示此 user_id 在 COACH 資料表上不能重複，因為一個「教練」只能對應到 一個「使用者」。

# 1. 分析流程：從欄位角度去規劃
- 以「用戶」角度：一位「用戶」有多篇「部落格文章」
- 以「部落格文章」角度：一篇「部落格文章」有一位「用戶」

- 以「訓練家」角度：一位「訓練家」有多隻「Pokémon 」
- 以「Pokémon 」角度：一隻「Pokémon 」有一位「訓練家」

- 以「書籍」角度：一本「書籍」有一位「作者」
- 以「作者」角度：一位「作者」有多本創作「書籍」

# 2. 依照上述描述，他是一對一關係、還是一對多？
- 用戶與部落格文章的資料表：一對多的關係
- 訓練家與Pokémon 的資料表：一對多的關係
- 作者與書籍的資料表：一對多的關係

SEE YOU TOMORROW (σ′▽‵)′▽‵)σ