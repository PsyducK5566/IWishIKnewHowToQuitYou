---
title: 妳說, 後端資料庫體驗營到底有什麼? 貳
date: 2024-11-26 01:29:17
tags: Practice
description: 就是要尋找那什麼
---
續

#### 情境講解
1. 為滿足商業需求的組合包方案，於是建立了 <code>CREDIT_PACKAGE</code> 資料表，來記錄各組合包資訊
2. 客戶在買的訂單記錄，都會記錄在 <code>CREDIT_PURCHASE</code> 資料表中

#### 資料庫預設資訊與欄位介紹

1. **USER**：使用者資料
2. **CREDIT_PACKAGE**：組合包方案
  + <code>credit_amount</code>：堂數
  + <code>price</code>:金額
3. **CREDIT_PURCHASE**：客戶購買課程堂數
  + <code>user_id</code>：使用者(USER) 的 id 資訊
  + <code>purchased_credits</code>：購買堂數
  + <code>price_paid</code>：購買金額

```sql
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE TABLE "USER" (
  "id" uuid PRIMARY KEY NOT NULL DEFAULT (gen_random_uuid()),
  "name" varchar(50) NOT NULL,
  "email" varchar(320) UNIQUE NOT NULL,
  "role" varchar(20) NOT NULL,
  "created_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP),
  "updated_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP)
);

CREATE TABLE "CREDIT_PACKAGE" (
  "id" serial PRIMARY KEY,
  "name" varchar(50) NOT NULL,
  "credit_amount" integer NOT NULL,
  "price" numeric(10,2) NOT NULL,
  "created_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP)
);

CREATE TABLE "CREDIT_PURCHASE" (
  "id" uuid PRIMARY KEY NOT NULL DEFAULT (gen_random_uuid()),
  "user_id" uuid NOT NULL REFERENCES "USER"(id),
  "credit_package_id" integer NOT NULL REFERENCES "CREDIT_PACKAGE"(id),
  "purchased_credits" integer NOT NULL,
  "price_paid" numeric(10,2) NOT NULL,
  "created_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP),
  "purchase_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP)
);
```
這段 SQL 語句創建了三個資料表，分別是 USER、CREDIT_PACKAGE 和 CREDIT_PURCHASE

**USER 表**
用於存儲用戶的基本信息。

```sql
CREATE TABLE "USER" (
  "id" uuid PRIMARY KEY NOT NULL DEFAULT (gen_random_uuid()), -- 唯一標識符，使用 UUID 自動生成
  "name" varchar(50) NOT NULL,                               -- 用戶名稱，最多 50 字元，必填
  "email" varchar(320) UNIQUE NOT NULL,                     -- 電子郵件，最多 320 字元，必填且唯一
  "role" varchar(20) NOT NULL,                              -- 用戶角色，必填，可能的值如 "USER" 或 "COACH"
  "created_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP), -- 創建時間，默認為當前時間
  "updated_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP)  -- 更新時間，默認為當前時間
);
```
>**id：**使用 <code>gen_random_uuid()</code> 自動生成唯一標識符。
>**email：**設置了唯一性約束，確保每個用戶的電子郵件地址不重複。
>**role：**用戶角色欄位，可用於區分普通用戶和其他角色（如教練）。
><code>created_at</code>和<code>updated_at</code>：用於記錄用戶的創建和更新時間。

**CREDIT_PACKAGE 表**
用於存儲信用點數套餐的詳細信息。

```sql
CREATE TABLE "CREDIT_PACKAGE" (
  "id" serial PRIMARY KEY,                       -- 唯一標識符，自動遞增
  "name" varchar(50) NOT NULL,                  -- 套餐名稱，最多 50 字元，必填
  "credit_amount" integer NOT NULL,             -- 套餐中包含的信用點數數量，必填
  "price" numeric(10,2) NOT NULL,               -- 套餐價格，必填，精確到小數點後兩位
  "created_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP) -- 創建時間，默認為當前時間
);
```

>**id：**使用 <code>serial</code>
>**credit_amount：**存儲套餐中包含的信用點數數量。 自動生成唯一標識符。
>**price：**記錄套餐的價格，使用 <code>numeric(10,2)</code> 確保價格的精度。
>**created_at：**記錄套餐的創建時間。

**CREDIT_PURCHASE 表**
用於記錄用戶購買信用點數的交易。

```sql
CREATE TABLE "CREDIT_PURCHASE" (
  "id" uuid PRIMARY KEY NOT NULL DEFAULT (gen_random_uuid()), -- 唯一標識符，使用 UUID 自動生成
  "user_id" uuid NOT NULL REFERENCES "USER"(id),             -- 外鍵，引用 "USER" 表的 id
  "credit_package_id" integer NOT NULL REFERENCES "CREDIT_PACKAGE"(id), -- 外鍵，引用 "CREDIT_PACKAGE" 表的 id
  "purchased_credits" integer NOT NULL,                      -- 購買的信用點數數量
  "price_paid" numeric(10,2) NOT NULL,                       -- 實際支付的金額，精確到小數點後兩位
  "created_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP), -- 創建時間，默認為當前時間
  "purchase_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP) -- 購買時間，默認為當前時間
);
```
>**id：**使用 <code>gen_random_uuid()</code>自動生成唯一標識符。
>**user_id：**外鍵，指向<code>USER</code> 表中的 <code>id</code>用於關聯用戶。
>**credit_package_id：**外鍵，指向<code>CREDIT_PACKAGE</code>表中的<code>id</code>，用於關聯購買的信用點數套餐。
>**purchased_credits：**記錄購買的信用點數數量。
>**price_paid：**記錄用戶實際支付的金額。
>**purchase_at：**記錄交易發生的時間。

### 資料表之間的關聯
**USER 與 CREDIT_PURCHASE**
><code>CREDIT_PURCHASE.user_id</code>是外鍵，指向 <code>USER.id</code>。
>表示每筆信用點數購買記錄都關聯到一個用戶。

**CREDIT_PACKAGE 與 CREDIT_PURCHASE**
><code>CREDIT_PURCHASE.credit_package_id</code>是外鍵，指向 <code>CREDIT_PACKAGE.id</code>。
>表示每筆購買記錄都關聯到一個信用點數套餐。

**<font color=#FF0000> 注意事項 </font>**
**uuid-ossp 擴展**
>必須啟用 <code>uuid-ossp </code>擴展，才能使用 <code>gen_random_uuid()</code> 生成 <code>UUID</code>。如果未啟用，可執行以下語句：

```sql
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
```

**外鍵約束**
>外鍵約束 <code>(REFERENCES) </code>確保數據的一致性。例如，<code>CREDIT_PURCHASE.user_id </code>必須是 <code>USER </code>表中已存在的 <code>id</code>。

##　組合包方案 CREDIT_PACKAGE 
### 1. 新增：在CREDIT_PACKAGE 資料表新增三筆資料，資料需求如下：
 + 名稱為 7 堂組合包方案，價格為1,400 元，堂數為7
 + 名稱為14 堂組合包方案，價格為2,520 元，堂數為14
 + 名稱為 21 堂組合包方案，價格為4,800 元，堂數為21

以下是向 CREDIT_PACKAGE 資料表新增三筆資料的 SQL 語句：

<font color=#0000FF> ln [1]: </font>

```sql
INSERT INTO "CREDIT_PACKAGE" (name, credit_amount, price)
VALUES
  ('7 堂組合包方案', 7, 1400.00),
  ('14 堂組合包方案', 14, 2520.00),
  ('21 堂組合包方案', 21, 4800.00);
```
<font color=#FF0000> Out [1]:  </font>

![](https://firebasestorage.googleapis.com/v0/b/pictureforu-3b8e9.appspot.com/o/SQL%20%3A%2020241126%20Practice%2F1.png?alt=media&token=d377ed6b-a4e4-4ff0-810e-38d3aa0d94d6)

**<code>INSERT INTO "CREDIT_PACKAGE"</code>**
>指定要插入數據的資料表為 <code>CREDIT_PACKAGE</code>。
>欄位包含 name（名稱）、credit_amount（堂數）、price（價格）。

**價格格式**
>使用 <code>numeric(10,2)</code> 格式，確保價格精確到小數點後兩位。

執行此語句後，CREDIT_PACKAGE 資料表中將新增三筆資料，id 和 created_at 欄位會根據表的設定自動生成。

**驗證插入結果**
<font color=#0000FF> ln [2]: </font>

```sql
SELECT * FROM "CREDIT_PACKAGE";
```

<font color=#FF0000> Out [2]:  </font>

![](https://firebasestorage.googleapis.com/v0/b/pictureforu-3b8e9.appspot.com/o/SQL%20%3A%2020241126%20Practice%2F1-Table.png?alt=media&token=16fe8cc7-70dd-4f3e-b8b0-afb158590753)

## 客戶購買課程堂數 CREDIT_PURCHASE
### 2. 新增：在 CREDIT_PURCHASE 資料表，新增三筆資料：（請使用 name 欄位做子查詢）
 + 王小明 購買 14 堂組合包方案
 + 王小明 購買 21 堂組合包方案
 + 好野人 購買 14 堂組合包方案

 ```sql
-- 王小明提示範例
insert into "CREDIT_PURCHASE" (user_id, credit_package_id, purchased_credits, price_paid) values
((select id from "USER" where email = 'wXlTq@hexschooltest.io'),
  (select id from "CREDIT_PACKAGE" where name = '14 堂組合包方案'),
  (select credit_amount from "CREDIT_PACKAGE" where name = '14 堂組合包方案'),
  (select price from "CREDIT_PACKAGE" where name = '14 堂組合包方案'))
 ```
根據校長提供的範例，這段 SQL 是用來插入一筆資料到 CREDIT_PURCHASE 資料表，並且透過子查詢從其他資料表（例如 USER 和 CREDIT_PACKAGE）中取得相關欄位的值。
以下是基於提示範例，新增三筆資料的語法：

<font color=#0000FF> ln [3]: </font>

```sql
-- 王小明 購買 14 堂組合包方案
INSERT INTO "CREDIT_PURCHASE" (user_id, credit_package_id, purchased_credits, price_paid) 
VALUES (
  (SELECT id FROM "USER" WHERE email = 'wXlTq@hexschooltest.io'), -- 王小明的 email
  (SELECT id FROM "CREDIT_PACKAGE" WHERE name = '14 堂組合包方案'), -- 14 堂組合包方案的 id
  (SELECT credit_amount FROM "CREDIT_PACKAGE" WHERE name = '14 堂組合包方案'), -- 堂數
  (SELECT price FROM "CREDIT_PACKAGE" WHERE name = '14 堂組合包方案') -- 價格
);

-- 王小明 購買 21 堂組合包方案
INSERT INTO "CREDIT_PURCHASE" (user_id, credit_package_id, purchased_credits, price_paid) 
VALUES (
  (SELECT id FROM "USER" WHERE email = 'wXlTq@hexschooltest.io'), -- 王小明的 email
  (SELECT id FROM "CREDIT_PACKAGE" WHERE name = '21 堂組合包方案'), -- 21 堂組合包方案的 id
  (SELECT credit_amount FROM "CREDIT_PACKAGE" WHERE name = '21 堂組合包方案'), -- 堂數
  (SELECT price FROM "CREDIT_PACKAGE" WHERE name = '21 堂組合包方案') -- 價格
);

-- 好野人 購買 14 堂組合包方案
INSERT INTO "CREDIT_PURCHASE" (user_id, credit_package_id, purchased_credits, price_paid) 
VALUES (
  (SELECT id FROM "USER" WHERE email = 'richman@hexschooltest.io'), -- 好野人的 email
  (SELECT id FROM "CREDIT_PACKAGE" WHERE name = '14 堂組合包方案'), -- 14 堂組合包方案的 id
  (SELECT credit_amount FROM "CREDIT_PACKAGE" WHERE name = '14 堂組合包方案'), -- 堂數
  (SELECT price FROM "CREDIT_PACKAGE" WHERE name = '14 堂組合包方案') -- 價格
);
```
<font color=#FF0000> Out [3]:  </font>
![](https://firebasestorage.googleapis.com/v0/b/pictureforu-3b8e9.appspot.com/o/SQL%20%3A%2020241126%20Practice%2F2.png?alt=media&token=ddae3083-d881-4664-8207-fcd497906152)

**INSERT INTO：**
>向 <code>CREDIT_PURCHASE</code> 資料表新增資料。
>>user_id：用戶 ID。
>>credit_package_id：信用套組 ID。
>>purchased_credits：購買的堂數。
>>price_paid：支付的金額。

**子查詢：**
>(SELECT id FROM "USER" WHERE email = 'wXlTq@hexschooltest.io')：
>>從 USER 資料表中查詢 email 為 wXlTq@hexschooltest.io 的用戶 ID。

>(SELECT id FROM "CREDIT_PACKAGE" WHERE name = '14 堂組合包方案')：
>>從 CREDIT_PACKAGE 資料表中查詢名稱為 14 堂組合包方案 的套組 ID。

>(SELECT credit_amount FROM "CREDIT_PACKAGE" WHERE name = '14 堂組合包方案')：
>>從 CREDIT_PACKAGE 資料表中查詢名稱為 14 堂組合包方案 的堂數。

>(SELECT price FROM "CREDIT_PACKAGE" WHERE name = '14 堂組合包方案')：
>>從 CREDIT_PACKAGE 資料表中查詢名稱為 14 堂組合包方案 的價格。

最後要查看 CREDIT_PURCHASE 資料表的詳細內容，並且結合 USER 和 CREDIT_PACKAGE 資料表，可以使用 JOIN 語法來查詢，這樣能更清楚地看到每筆交易的用戶名稱、購買的套餐名稱、堂數與支付金額等資訊。

<font color=#0000FF> ln [4]: </font>

```sql
SELECT 
  cp.id AS 購買記錄id,                  -- 購買記錄的唯一識別碼
  u.name AS 消費者名稱,                -- 用戶名稱
  p.name AS 課程名稱,                  -- 購買的課程名稱
  cp.purchased_credits AS 購買堂數,    -- 購買的課程堂數
  cp.price_paid AS 付款金額,           -- 支付的金額
  cp.created_at AS 購買時間            -- 購買的時間戳
FROM "CREDIT_PURCHASE" cp
JOIN "USER" u ON cp.user_id = u.id        -- 將 CREDIT_PURCHASE 和 USER 資料表連接
JOIN "CREDIT_PACKAGE" p ON cp.credit_package_id = p.id; -- 將 CREDIT_PURCHASE 和 CREDIT_PACKAGE 資料表連接
```

<font color=#FF0000> Out [4]:  </font>
![](https://firebasestorage.googleapis.com/v0/b/pictureforu-3b8e9.appspot.com/o/SQL%20%3A%2020241126%20Practice%2F2-Table.png?alt=media&token=0c42fd13-169b-4510-ad8c-9a52dbe507cb)

**為什麼需要 <code>JOIN </code>？**
+ CREDIT_PURCHASE 資料表記錄了購買的基本資訊，但它只包含用戶的 user_id 和課程包的 credit_package_id，而不是用戶的名字或課程的名稱。
+ USER 資料表存儲了用戶的詳細資訊（如名字），而 CREDIT_PACKAGE 資料表存儲了課程包的詳細資訊（如名稱）。
+ 使用 <code>JOIN</code>，我們可以通過關聯欄位（user_id 和 credit_package_id）將這些資料表結合，從而獲取完整的資訊

SEE YOU TOMORROW (σ′▽‵)′▽‵)σ